<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SentinelDrive | Driver DMS</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
body {
  font-family: 'Orbitron', sans-serif;
  background: radial-gradient(circle at top, #020617, #000);
}
.glow-green { box-shadow: 0 0 30px #22c55e66; }
.glow-yellow { box-shadow: 0 0 30px #eab30866; }
.glow-red { box-shadow: 0 0 40px #ef444466; }
.pulse { animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
</style>
</head>

<body class="h-screen flex text-white overflow-hidden">

<!-- SIDEBAR -->
<div class="w-80 p-6 bg-black/60 backdrop-blur-xl border-r border-white/10 flex flex-col gap-6">
  <div>
    <h1 class="text-xl font-black tracking-widest">ðŸš— SENTINELDRIVE</h1>
    <p class="text-xs text-slate-400">Driver Monitoring System</p>
  </div>

  <div class="flex flex-col items-center gap-2">
    <div id="statusRing"
      class="w-28 h-28 rounded-full border-4 border-emerald-400 glow-green flex items-center justify-center">
      <span id="statusText" class="text-lg font-bold">NORMAL</span>
    </div>
    <p class="text-xs text-slate-400 tracking-widest">STATE</p>
  </div>

  <div>
    <p class="text-xs text-slate-400">EAR</p>
    <div class="h-2 bg-slate-800 rounded">
      <div id="earBar" class="h-2 bg-blue-500 rounded"></div>
    </div>
    <p id="earVal" class="text-sm">0.00</p>
  </div>

  <div>
    <p class="text-xs text-slate-400">MAR</p>
    <div class="h-2 bg-slate-800 rounded">
      <div id="marBar" class="h-2 bg-orange-500 rounded"></div>
    </div>
    <p id="marVal" class="text-sm">0.00</p>
  </div>

  <div>
    <p class="text-xs text-slate-400 mb-1">FATIGUE SCORE</p>
    <canvas id="fatigueChart" height="80"></canvas>
  </div>

  <p class="text-xs text-slate-500 mt-auto tracking-widest">
    LIVE VEHICLE SAFETY MONITOR
  </p>
</div>

<!-- CAMERA -->
<div class="flex-1 relative">
  <video id="video" class="absolute inset-0 w-full h-full object-cover scale-x-[-1] opacity-80" autoplay playsinline></video>
  <canvas id="hud" class="absolute inset-0 w-full h-full scale-x-[-1]"></canvas>

  <div id="alert"
    class="hidden absolute inset-0 bg-red-600/30 backdrop-blur-sm flex flex-col items-center justify-center z-50">
    <h1 class="text-7xl font-black pulse">CRITICAL ALERT</h1>
    <p class="mt-4 text-xl">DRIVER DROWSINESS</p>
  </div>

  <div id="cameraStatus" class="absolute top-4 left-4 bg-black/60 backdrop-blur px-4 py-2 rounded-lg text-sm">
    <span class="text-slate-400">Camera:</span> <span id="cameraInfo" class="text-white">Initializing...</span>
  </div>
</div>

<scripvideo = document.getElementById("video");
const hud = document.getElementById("hud");
const hctx = hud.getContext("2d");
const cameraInfo = document.getElementById("cameraInfo
const socket = io();
const img = document.getElementById("video");
const hud = document.getElementById("hud");
const hctx = hud.getContext("2d");

const earVal = document.getElementById("earVal");
const marVal = document.getElementById("marVal");
const earBar = document.getElementById("earBar");
const marBar = document.getElementById("marBar");

const statusRing = document.getElementById("statusRing");
const statusText = document.getElementById("statusText");
const alertBox = document.getElementById("alert");

const fcan = document.getElementById("fatigueChart");
const fctx = fcan.getContext("2d");

let fatigue = 0, history = [];
let state = "NORMAL", drowsyStart = null;
let alarm = false, audioCtx, osc;

function buzzer(on) {
  if (on && !alarm) {
    audioCtx = new AudioContext();
    osc = audioCtx.createOscillator();
    osc.frequency.value = 900;
    osc.connect(audioCtx.destination);
    osc.start();
    alarm = true;
  }
  if (!on && alarm) {
    osc.stop();
    alarm = false;
  }video.clientWidth;
  hud.height = video.clientHeight;
}
window.addEventListener("resize", resizeHUD);

// Initialize webcam
async function initCamera() {
  try {
    cameraInfo.textContent = "Requesting camera access...";
    
    // Request HD camera with high resolution
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: 1920 },
        height: { ideal: 1080 },
        frameRate: { ideal: 30 }
      },
      audio: false
    });
    
    video.srcObject = stream;
    
    // Get actual camera info
    const track = stream.getVideoTracks()[0];
    const settings = track.getSettings();
    cameraInfo.textContent = `${settings.width}x${settings.height} @ ${settings.frameRate}fps`;
    
    console.log("ðŸ“· Camera opened:", settings);
    
    // Wait for video to be ready
    await new Promise((resolve) => {
      video.onloadedmetadata = () => {
        video.play();
        resolve();
      // HUD
      hctx.clearRect(0,0,hud.width,hud.height);
      hctx.fillStyle = "rgba(59,130,246,.8)";
      [33,133,362,263,13,14].forEach(i=>{
        const p = lm[i];
        hctx.beginPath();
        hctx.arc(p.x*hud.width,p.y*hud.height,3,0,Math.PI*2);
        hctx.fill();
      });

      const ear =
        ((dist(lm[160],lm[144])+dist(lm[158],lm[153])) /
        (2*dist(lm[33],lm[133])) +
        (dist(lm[385],lm[380])+dist(lm[387],lm[373])) /
        (2*dist(lm[362],lm[263]))) / 2;

      const mar = dist(lm[13],lm[14]) / dist(lm[78],lm[308]);

      earVal.innerText = ear.toFixed(2);
      marVal.innerText = mar.toFixed(2);
      earBar.style.width = Math.min(ear*300,100)+"%";
      marBar.style.width = Math.min(mar*200,100)+"%";

      // Fatigue
      if (ear < 0.22) fatigue += 2;
      if (mar > 0.6) fatigue += 1;
      fatigue = Math.max(0, Math.min(100, fatigue - 0.5));
      history.push(fatigue);
      if (history.length > 100) history.shift();

      fctx.clearRect(0,0,fcan.width,fcan.height);
      fctx.strokeStyle = "#22c55e";
      fctx.beginPath();
      history.forEach((v,i)=>{
        const x=i/history.length*fcan.width;
        const y=fcan.height-(v/100)*fcan.height;
        i?fctx.lineTo(x,y):fctx.moveTo(x,y);
      });
      fctx.stroke();

      const timestamp = Date.now();
      const drowsy = ear < 0.22 || mar > 0.6;
      if (drowsy && !drowsyStart) drowsyStart = timestamp;
      if (!drowsy) drowsyStart = null;

      if (!drowsy) state="NORMAL";
      else if (timestamp-drowsyStart<1500) state="WARNING";
      else state="CRITICAL";

      if (state==="NORMAL") {
        statusText.innerText="NORMAL";
        statusRing.className="w-28 h-28 rounded-full border-4 border-emerald-400 glow-green flex items-center justify-center";
        alertBox.classList.add("hidden");
        buzzer(false);
      } else if (state==="WARNING") {
        statusText.innerText="WARNING";
        statusRing.className="w-28 h-28 rounded-full border-4 border-yellow-400 glow-yellow pulse flex items-center justify-center";
        alertBox.classList.add("hidden");
        buzzer(false);
      } else {
        statusText.innerText="CRITICAL";
        statusRing.className="w-28 h-28 rounded-full border-4 border-red-500 glow-red pulse flex items-center justify-center";
        alertBox.classList.remove("hidden");
        buzzer(true);
      }
    }
  }
  
  requestAnimationFrame(processFrame);
}

// Start processing
processFrame( const mar = dist(lm[13],lm[14]) / dist(lm[78],lm[308]);

  earVal.innerText = ear.toFixed(2);
  marVal.innerText = mar.toFixed(2);
  earBar.style.width = Math.min(ear*300,100)+"%";
  marBar.style.width = Math.min(mar*200,100)+"%";

  // Fatigue
  if (ear < 0.22) fatigue += 2;
  if (mar > 0.6) fatigue += 1;
  fatigue = Math.max(0, Math.min(100, fatigue - 0.5));
  history.push(fatigue);
  if (history.length > 100) history.shift();

  fctx.clearRect(0,0,fcan.width,fcan.height);
  fctx.strokeStyle = "#22c55e";
  fctx.beginPath();
  history.forEach((v,i)=>{
    const x=i/history.length*fcan.width;
    const y=fcan.height-(v/100)*fcan.height;
    i?fctx.lineTo(x,y):fctx.moveTo(x,y);
  });
  fctx.stroke();

  const now = Date.now();
  const drowsy = ear < 0.22 || mar > 0.6;
  if (drowsy && !drowsyStart) drowsyStart = now;
  if (!drowsy) drowsyStart = null;

  if (!drowsy) state="NORMAL";
  else if (now-drowsyStart<1500) state="WARNING";
  else state="CRITICAL";

  if (state==="NORMAL") {
    statusText.innerText="NORMAL";
    statusRing.className="w-28 h-28 rounded-full border-4 border-emerald-400 glow-green flex items-center justify-center";
    alertBox.classList.add("hidden");
    buzzer(false);
  } else if (state==="WARNING") {
    statusText.innerText="WARNING";
    statusRing.className="w-28 h-28 rounded-full border-4 border-yellow-400 glow-yellow pulse flex items-center justify-center";
    alertBox.classList.add("hidden");
    buzzer(false);
  } else {
    statusText.innerText="CRITICAL";
    statusRing.className="w-28 h-28 rounded-full border-4 border-red-500 glow-red pulse flex items-center justify-center";
    alertBox.classList.remove("hidden");
    buzzer(true);
  }
});
</script>
</body>
</html>
